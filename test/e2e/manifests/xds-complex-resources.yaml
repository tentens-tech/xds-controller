---
# =============================================================================
# Complex E2E Test Resources - Production-like configurations
# Purpose: Test that complex Envoy configs are correctly applied via xDS
# All routes point to test-backend for actual traffic testing
# =============================================================================

# -----------------------------------------------------------------------------
# TLS SECRETS (SDS) - Self-signed certificates for testing
# -----------------------------------------------------------------------------

---
apiVersion: envoyxds.io/v1alpha1
kind: TLSSecret
metadata:
  name: e2e-wildcard-cert
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  domains:
    - "secure.e2e.local"
  config:
    type: Local

# -----------------------------------------------------------------------------
# CLUSTERS (CDS) - Complex cluster configurations
# -----------------------------------------------------------------------------

---
# Cluster with health checks, circuit breakers, and multi-zone locality
apiVersion: envoyxds.io/v1alpha1
kind: Cluster
metadata:
  name: complex-cluster
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  name: complex-cluster
  connect_timeout: 0.25s
  type: STRICT_DNS
  lb_policy: ROUND_ROBIN
  ignore_health_on_host_removal: true
  upstream_connection_options:
    tcp_keepalive: {}
  health_checks:
    - timeout: 2s
      interval: 5s
      unhealthy_threshold: 5
      healthy_threshold: 1
      http_health_check:
        path: /
  load_assignment:
    cluster_name: complex-cluster
    endpoints:
      - lb_endpoints:
          - endpoint:
              health_check_config:
                port_value: 80
              address:
                socket_address:
                  address: test-backend.xds-system.svc.cluster.local
                  port_value: 80
        locality:
          zone: zone-a
      - lb_endpoints:
          - endpoint:
              health_check_config:
                port_value: 80
              address:
                socket_address:
                  address: test-backend.xds-system.svc.cluster.local
                  port_value: 80
        locality:
          zone: zone-b
  circuit_breakers:
    thresholds:
      - max_connections: 2000000
        max_pending_requests: 2000000
        max_requests: 2000000
        max_retries: 3

---
# Simple cluster for basic routing tests
apiVersion: envoyxds.io/v1alpha1
kind: Cluster
metadata:
  name: simple-cluster
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  name: simple-cluster
  connect_timeout: 5s
  type: STRICT_DNS
  lb_policy: ROUND_ROBIN
  load_assignment:
    cluster_name: simple-cluster
    endpoints:
      - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: test-backend.xds-system.svc.cluster.local
                  port_value: 80

---
# TCP proxy cluster
apiVersion: envoyxds.io/v1alpha1
kind: Cluster
metadata:
  name: tcp-cluster
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  name: tcp-cluster
  connect_timeout: 5s
  type: STRICT_DNS
  lb_policy: ROUND_ROBIN
  load_assignment:
    cluster_name: tcp-cluster
    endpoints:
      - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: test-backend.xds-system.svc.cluster.local
                  port_value: 80

# -----------------------------------------------------------------------------
# LISTENERS (LDS) - Complex listener configurations  
# -----------------------------------------------------------------------------

---
# HTTP Listener (port 8081) - complex test listener (separate from basic 8080)
apiVersion: envoyxds.io/v1alpha1
kind: Listener
metadata:
  name: http-complex
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 8081

---
# HTTPS Listener with TLS Inspector (port 8443)
apiVersion: envoyxds.io/v1alpha1
kind: Listener
metadata:
  name: https-complex
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 8443
  listener_filters:
    - name: envoy.filters.listener.tls_inspector
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector

---
# QUIC/UDP Listener (port 8444) - HTTP/3 support
apiVersion: envoyxds.io/v1alpha1
kind: Listener
metadata:
  name: quic-complex
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  address:
    socket_address:
      address: 0.0.0.0
      protocol: UDP
      port_value: 8444
  udp_listener_config:
    downstream_socket_config:
      prefer_gro: true
    quic_options: {}

---
# TCP Proxy Listener (port 9000)
apiVersion: envoyxds.io/v1alpha1
kind: Listener
metadata:
  name: tcp-complex
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9000
  filter_chains:
    - filters:
        - name: envoy.filters.network.tcp_proxy
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.network.tcp_proxy.v3.TcpProxy
            stat_prefix: tcp_e2e
            cluster: tcp-cluster

# -----------------------------------------------------------------------------
# ROUTES (RDS) - Complex HTTP routing configurations
# All routes use http-complex listener to avoid filter chain conflicts
# -----------------------------------------------------------------------------

---
# Route 1: Full-featured route with CORS, compression (Brotli), access logging
# Test path: /api/* - proxies to complex-cluster
apiVersion: envoyxds.io/v1alpha1
kind: Route
metadata:
  name: api-route
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  listener_refs:
    - http-complex
  stat_prefix: api-route
  use_remote_address: true
  internal_address_config:
    unix_sockets: true
  generate_request_id: true
  codec_type: AUTO
  common_http_protocol_options:
    idle_timeout: 900s
  route_config:
    name: api_route_config
    virtual_hosts:
      - name: api_host
        domains:
          - "*"
        typed_per_filter_config:
          envoy.filters.http.cors:
            "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.CorsPolicy
            allow_credentials: true
            allow_origin_string_match:
              - safe_regex:
                  regex: ".*"
            allow_methods: GET,POST,PUT,DELETE,OPTIONS,HEAD
            allow_headers: Authorization,Content-Type,X-Requested-With,Accept,Origin,X-Custom-Header
            max_age: 24h
        response_headers_to_add:
          - header:
              key: x-e2e-test
              value: "api-route"
        routes:
          # API endpoint with retry policy - rewrites /api/* to /*
          - match:
              prefix: /api/
            request_headers_to_add:
              - header:
                  key: x-route
                  value: api
            route:
              prefix_rewrite: /
              timeout: 15s
              cluster: complex-cluster
              retry_policy:
                retry_host_predicate:
                  - name: envoy.retry_host_predicates.previous_hosts
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.retry.host.previous_hosts.v3.PreviousHostsPredicate
                host_selection_retry_max_attempts: 2
                retriable_status_codes:
                  - 503
                retry_on: connect-failure,cancelled,retriable-status-codes
                num_retries: 3
          # gRPC endpoint (header-based routing) - rewrites /grpc/* to /*
          - match:
              prefix: /grpc/
              headers:
                - name: content-type
                  string_match:
                    prefix: "application/grpc"
            route:
              prefix_rewrite: /
              timeout: 30s
              cluster: complex-cluster
          # Health endpoint - simple routing, rewrites to /
          - match:
              prefix: /health
            route:
              prefix_rewrite: /
              timeout: 5s
              cluster: simple-cluster
          # Redirect test path
          - match:
              prefix: /old/
            redirect:
              path_redirect: /new/
              response_code: MOVED_PERMANENTLY
          # Default catch-all
          - match:
              prefix: /
            request_headers_to_add:
              - header:
                  key: x-route
                  value: default
            route:
              timeout: 15s
              cluster: simple-cluster
  access_log:
    - name: envoy.access_loggers.file
      filter:
        status_code_filter:
          comparison:
            op: GE
            value:
              default_value: 400
              runtime_key: access_log.error.status
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
        path: /dev/stdout
        log_format:
          json_format:
            time: "%START_TIME%"
            method: "%REQ(:METHOD)%"
            path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
            code: "%RESPONSE_CODE%"
            duration: "%DURATION%"
            upstream: "%UPSTREAM_HOST%"
            cluster: "%UPSTREAM_CLUSTER%"
            request_id: "%REQ(X-REQUEST-ID)%"
  http_filters:
    - name: envoy.filters.http.cors
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
    - name: envoy.filters.http.compressor
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor
        response_direction_config:
          common_config:
            min_content_length: 100
        compressor_library:
          name: text_optimized
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.compression.brotli.compressor.v3.Brotli
            quality: 4
    - name: envoy.grpc_web
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb
    - name: envoy.filters.http.grpc_stats
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.http.grpc_stats.v3.FilterConfig
        stats_for_all_methods: false
        enable_upstream_stats: true
        emit_filter_state: true
    - name: envoy.filters.http.lua
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
        default_source_code:
          inline_string: |
            function envoy_on_request(request_handle)
              request_handle:headers():add("x-lua-processed", "true")
            end
            function envoy_on_response(response_handle)
              response_handle:headers():add("x-lua-response", "processed")
            end
    - name: envoy.filters.http.router
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

---
# Route 2: HTTPS/QUIC route with TLS termination - references TWO listeners
apiVersion: envoyxds.io/v1alpha1
kind: Route
metadata:
  name: https-route
  namespace: xds-system
  annotations:
    clusters: "e2e-test"
    nodes: "e2e-test-node"
spec:
  listener_refs:
    - https-complex   # HTTPS on port 8443
    - quic-complex    # QUIC/HTTP3 on port 8444
  tlssecret_ref: e2e-wildcard-cert
  filter_chain_match:
    server_names:
      - secure.e2e.local
  stat_prefix: https-route
  use_remote_address: true
  internal_address_config:
    unix_sockets: true
  codec_type: AUTO
  route_config:
    name: https_route_config
    virtual_hosts:
      - name: secure_host
        domains:
          - "*"
        response_headers_to_add:
          - header:
              key: x-e2e-test
              value: "https-route"
          - header:
              key: strict-transport-security
              value: "max-age=31536000; includeSubDomains"
          - header:
              key: alt-svc
              value: "h3=\":8444\"; ma=86400"
        routes:
          - match:
              prefix: /
            route:
              prefix_rewrite: /
              timeout: 15s
              cluster: simple-cluster
  http_filters:
    - name: envoy.filters.http.router
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

name: CI

on:
  push:
    branches: [ main ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
      - 'Makefile'
      - '.golangci.yml'
      - 'config/**'
      - 'test/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
      - 'Makefile'
      - '.golangci.yml'
      - 'config/**'
      - 'test/**'
      - '.github/workflows/ci.yml'

env:
  GO_VERSION: '1.25'

# Default permissions for all jobs
permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read  # Required for only-new-issues
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          # Show only new issues on PRs
          only-new-issues: true
          # Enable problem matchers for inline annotations
          problem-matchers: true

      - name: Generate lint report summary
        if: always()
        run: |
          echo "## ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Lint check completed - see annotations in Files Changed tab" >> $GITHUB_STEP_SUMMARY

  test:
    name: Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write  # Required for test report annotations
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Run tests with JUnit output
        run: |
          # Get list of packages excluding generated code directories
          PACKAGES=$(go list ./... | grep -v '/tools/typegen/' | tr '\n' ',')
          PACKAGES=${PACKAGES%,}  # Remove trailing comma
          
          gotestsum --junitfile junit.xml --format testdox -- -race -coverprofile=coverage.raw.out -covermode=atomic ./...
          
          # Filter out generated files from coverage report
          grep -v '_generated\.go\|zz_generated\|/mock/' coverage.raw.out > coverage.out || cp coverage.raw.out coverage.out

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f junit.xml ]; then
            TESTS=$(grep -o 'tests="[0-9]*"' junit.xml | head -1 | grep -o '[0-9]*')
            FAILURES=$(grep -o 'failures="[0-9]*"' junit.xml | head -1 | grep -o '[0-9]*')
            ERRORS=$(grep -o 'errors="[0-9]*"' junit.xml | head -1 | grep -o '[0-9]*')
            TIME=$(grep -o 'time="[0-9.]*"' junit.xml | head -1 | grep -o '[0-9.]*')
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | ${TESTS:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $((${TESTS:-0} - ${FAILURES:-0} - ${ERRORS:-0})) |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | ${FAILURES:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| Errors | ${ERRORS:-0} |" >> $GITHUB_STEP_SUMMARY
            echo "| Duration | ${TIME:-0}s |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate coverage summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.out ]; then
            COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
            echo "**Total Coverage (excluding generated code): ${COVERAGE}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_Note: Generated files are excluded from coverage metrics:_" >> $GITHUB_STEP_SUMMARY
            echo "- \`*_generated.go\` (typegen: CDS, LDS, RDS, EDS types)" >> $GITHUB_STEP_SUMMARY
            echo "- \`zz_generated*.go\` (controller-gen: DeepCopy)" >> $GITHUB_STEP_SUMMARY
            echo "- \`/mock/*.go\` (mockgen: test mocks)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Coverage by package</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            go tool cover -func=coverage.out | head -30 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: |
            junit.xml
            coverage.out
          retention-days: 30

      - name: Test Report
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: Go Tests
          path: junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version info
        id: version
        run: |
          VERSION="dev-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "git_commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build binary
        run: |
          go build -ldflags "-X github.com/tentens-tech/xds-controller/pkg/version.Version=${{ steps.version.outputs.version }} \
                             -X github.com/tentens-tech/xds-controller/pkg/version.GitCommit=${{ steps.version.outputs.git_commit }} \
                             -X github.com/tentens-tech/xds-controller/pkg/version.BuildDate=${{ steps.version.outputs.build_date }}" \
            -o bin/xds ./cmd/xds/main.go

      - name: Verify binary
        run: |
          ls -la bin/
          ./bin/xds --version || true

      - name: Generate build summary
        run: |
          echo "## ðŸ”¨ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ steps.version.outputs.git_commit }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Date | ${{ steps.version.outputs.build_date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Binary Size | $(du -h bin/xds | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| Go Version | ${{ env.GO_VERSION }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload binary artifact
        uses: actions/upload-artifact@v6
        with:
          name: xds-binary-linux-amd64
          path: bin/xds
          retention-days: 7

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: xds-controller:e2e
          outputs: type=docker,dest=/tmp/xds-controller.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v6
        with:
          name: docker-image
          path: /tmp/xds-controller.tar
          retention-days: 1

  verify-manifests:
    name: Verify Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Generate manifests
        run: make manifests

      - name: Check for uncommitted changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "Generated manifests are not up to date. Please run 'make manifests' and commit the changes."
            git diff
            exit 1
          fi

  integration-test:
    name: Integration Test (E2E)
    runs-on: ubuntu-latest
    needs: docker-build  # Reuse the Docker image from docker-build job
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.34.2'

      - name: Download Docker image artifact
        uses: actions/download-artifact@v7
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load --input /tmp/xds-controller.tar

      - name: Create KIND cluster
        uses: helm/kind-action@v1.13.0
        with:
          cluster_name: xds-e2e
          version: v0.24.0
          wait: 60s

      - name: Load image into KIND cluster
        run: |
          kubectl cluster-info
          kind load docker-image xds-controller:e2e --name xds-e2e

      - name: Apply CRDs
        run: kubectl apply -f config/crd/bases/

      - name: Deploy xDS controller and test backend
        run: |
          kubectl apply -f test/e2e/manifests/namespace.yaml
          kubectl apply -f test/e2e/manifests/xds-controller.yaml
          kubectl apply -f test/e2e/manifests/test-backend.yaml

      - name: Wait for xDS controller
        run: |
          echo "Waiting for xds-controller..."
          kubectl rollout status deployment/xds-controller -n xds-system --timeout=180s
          echo "Waiting for test-backend..."
          kubectl rollout status deployment/test-backend -n xds-system --timeout=60s
          echo ""
          echo "=== xDS Controller logs (initial) ==="
          kubectl logs -l app=xds-controller -n xds-system --tail=30 || true

      - name: Apply xDS resources BEFORE Envoy starts
        run: |
          echo "Applying basic xDS resources..."
          kubectl apply -f test/e2e/manifests/xds-resources.yaml
          echo ""
          echo "Applying complex production-like xDS resources..."
          kubectl apply -f test/e2e/manifests/xds-complex-resources.yaml

      - name: Wait for xDS controller to reconcile
        run: |
          echo "Waiting for xDS controller to reconcile resources..."
          sleep 15
          echo ""
          echo "=== xDS Controller logs (after resources applied) ==="
          kubectl logs -l app=xds-controller -n xds-system --tail=30 || true
          echo ""
          echo "Verifying snapshot was created:"
          kubectl logs -l app=xds-controller -n xds-system | grep -E "Upgrading Envoy snapshot|Updated" || echo "No snapshot logs found yet"

      - name: Deploy Envoy (after xDS snapshot is ready)
        run: |
          echo "Deploying Envoy now that xDS snapshot should be ready..."
          kubectl apply -f test/e2e/manifests/envoy.yaml

      - name: Wait for Envoy
        run: |
          echo "Waiting for envoy..."
          kubectl rollout status deployment/envoy -n xds-system --timeout=180s

      - name: Verify pods are running
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n xds-system -o wide
          echo ""
          echo "=== xDS Controller logs ==="
          kubectl logs -l app=xds-controller -n xds-system --tail=30 || true
          echo ""
          echo "=== Envoy logs (initial) ==="
          kubectl logs -l app=envoy -n xds-system --tail=20 || true

      - name: Wait for Envoy to receive xDS configuration
        run: |
          echo "Waiting for Envoy to receive xDS configuration..."
          sleep 15
          echo "=== Envoy logs (after wait) ==="
          kubectl logs -l app=envoy -n xds-system --tail=30 || true

      - name: Get Envoy connection info
        id: envoy
        run: |
          NODE_IP=$(docker inspect xds-e2e-control-plane --format '{{.NetworkSettings.Networks.kind.IPAddress}}')
          ADMIN_PORT=$(kubectl get svc envoy -n xds-system -o jsonpath='{.spec.ports[?(@.name=="admin")].nodePort}')
          HTTP_PORT=$(kubectl get svc envoy -n xds-system -o jsonpath='{.spec.ports[?(@.name=="http")].nodePort}')
          HTTP_COMPLEX_PORT=$(kubectl get svc envoy -n xds-system -o jsonpath='{.spec.ports[?(@.name=="http-complex")].nodePort}')
          HTTPS_PORT=$(kubectl get svc envoy -n xds-system -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}')
          TCP_COMPLEX_PORT=$(kubectl get svc envoy -n xds-system -o jsonpath='{.spec.ports[?(@.name=="tcp-complex")].nodePort}')
          TCP_BASIC_PORT=$(kubectl get svc envoy -n xds-system -o jsonpath='{.spec.ports[?(@.name=="tcp-basic")].nodePort}')
          echo "node_ip=$NODE_IP" >> $GITHUB_OUTPUT
          echo "admin_port=$ADMIN_PORT" >> $GITHUB_OUTPUT
          echo "http_port=$HTTP_PORT" >> $GITHUB_OUTPUT
          echo "http_complex_port=$HTTP_COMPLEX_PORT" >> $GITHUB_OUTPUT
          echo "https_port=$HTTPS_PORT" >> $GITHUB_OUTPUT
          echo "tcp_complex_port=$TCP_COMPLEX_PORT" >> $GITHUB_OUTPUT
          echo "tcp_basic_port=$TCP_BASIC_PORT" >> $GITHUB_OUTPUT
          echo "Envoy Admin: http://${NODE_IP}:${ADMIN_PORT}"
          echo "Envoy HTTP (basic): http://${NODE_IP}:${HTTP_PORT}"
          echo "Envoy HTTP (complex): http://${NODE_IP}:${HTTP_COMPLEX_PORT}"
          echo "Envoy HTTPS: https://${NODE_IP}:${HTTPS_PORT}"
          echo "Envoy TCP (complex): tcp://${NODE_IP}:${TCP_COMPLEX_PORT}"
          echo "Envoy TCP (basic): tcp://${NODE_IP}:${TCP_BASIC_PORT}"

      - name: Verify Envoy received xDS configuration
        run: |
          NODE_IP="${{ steps.envoy.outputs.node_ip }}"
          ADMIN_PORT="${{ steps.envoy.outputs.admin_port }}"

          MAX_RETRIES=12
          RETRY_INTERVAL=5

          # Initialize xDS verification results as failed
          echo "XDS_CDS_RESULT=âŒ Failed" >> "$GITHUB_ENV"
          echo "XDS_LDS_RESULT=âŒ Failed" >> "$GITHUB_ENV"

          echo "=== Checking Envoy Clusters (with retry) ==="
          CLUSTER_FOUND=false
          for i in $(seq 1 $MAX_RETRIES); do
            CLUSTERS=$(curl -s "http://${NODE_IP}:${ADMIN_PORT}/clusters" || echo "FAILED")
            
            if echo "$CLUSTERS" | grep -q "complex-cluster"; then
              echo "âœ… Cluster 'complex-cluster' found in Envoy (attempt $i)"
              CLUSTER_FOUND=true
              break
            fi
            
            echo "â³ Cluster not found yet, retrying in ${RETRY_INTERVAL}s... (attempt $i/$MAX_RETRIES)"
            sleep $RETRY_INTERVAL
          done
          
          if [[ "$CLUSTER_FOUND" != "true" ]]; then
            echo "âŒ Cluster 'complex-cluster' NOT found after $MAX_RETRIES attempts"
            echo "$CLUSTERS" | head -50
            exit 1
          fi
          
          # Verify all expected clusters (MUST all be present)
          echo ""
          echo "Verifying all expected clusters..."
          CLUSTER_ERRORS=0
          for cluster_name in "complex-cluster" "simple-cluster" "tcp-cluster" "test-backend-cluster" "tcp-backend-cluster" "eds-test-cluster"; do
            if echo "$CLUSTERS" | grep -q "$cluster_name"; then
              echo "âœ… Cluster '$cluster_name' found"
            else
              echo "âŒ Cluster '$cluster_name' NOT found"
              ((CLUSTER_ERRORS++))
            fi
          done

          if [[ $CLUSTER_ERRORS -gt 0 ]]; then
            echo ""
            echo "âŒ $CLUSTER_ERRORS cluster(s) missing from Envoy configuration"
            exit 1
          fi

          echo "XDS_CDS_RESULT=âœ… Passed" >> "$GITHUB_ENV"

          echo ""
          echo "=== Checking Envoy Listeners (with retry) ==="
          LISTENER_FOUND=false
          for i in $(seq 1 $MAX_RETRIES); do
            LISTENERS=$(curl -s "http://${NODE_IP}:${ADMIN_PORT}/listeners" || echo "FAILED")
            
            if echo "$LISTENERS" | grep -q "0.0.0.0:8081"; then
              echo "âœ… Complex listener on 0.0.0.0:8081 found (attempt $i)"
              LISTENER_FOUND=true
              break
            fi
            
            echo "â³ Complex listener not found yet, retrying in ${RETRY_INTERVAL}s... (attempt $i/$MAX_RETRIES)"
            sleep $RETRY_INTERVAL
          done
          
          if [[ "$LISTENER_FOUND" != "true" ]]; then
            echo "âŒ Complex listener on 0.0.0.0:8081 NOT found after $MAX_RETRIES attempts"
            echo "$LISTENERS"
            exit 1
          fi
          
          # Verify all expected listeners (MUST all be present)
          echo ""
          echo "Verifying all expected listeners..."
          LISTENER_ERRORS=0
          for listener_addr in "0.0.0.0:8080" "0.0.0.0:8081" "0.0.0.0:8443" "0.0.0.0:8444" "0.0.0.0:9000" "0.0.0.0:9001"; do
            if echo "$LISTENERS" | grep -q "$listener_addr"; then
              echo "âœ… Listener on $listener_addr found"
            else
              echo "âŒ Listener on $listener_addr NOT found"
              ((LISTENER_ERRORS++))
            fi
          done

          if [[ $LISTENER_ERRORS -gt 0 ]]; then
            echo ""
            echo "âŒ $LISTENER_ERRORS listener(s) missing from Envoy configuration"
            exit 1
          fi

          echo "XDS_LDS_RESULT=âœ… Passed" >> "$GITHUB_ENV"

      - name: Test HTTP traffic through Envoy
        run: |
          NODE_IP="${{ steps.envoy.outputs.node_ip }}"
          HTTP_PORT="${{ steps.envoy.outputs.http_port }}"
          HTTP_COMPLEX_PORT="${{ steps.envoy.outputs.http_complex_port }}"
          HTTPS_PORT="${{ steps.envoy.outputs.https_port }}"

          MAX_RETRIES=6
          RETRY_INTERVAL=5
          TEST_FAILURES=0

          # Initialize all test results as failed (will be updated on success)
          echo "TEST_BASIC_HTTP=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_COMPLEX_HTTP=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_API_ROUTE=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_HEALTH=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_CORS=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_LUA=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_REDIRECT=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_HTTPS=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_TCP_COMPLEX=âŒ Failed" >> "$GITHUB_ENV"
          echo "TEST_TCP_BASIC=âŒ Failed" >> "$GITHUB_ENV"
          
          # Helper function to test HTTP request
          test_http() {
            local url=$1
            local expected_code=$2
            local description=$3
            local extra_args=${4:-}
            
            local response_code
            response_code=$(curl -s -o /dev/null -w "%{http_code}" $extra_args "$url" --max-time 10 || echo "000")
            
            if [[ "$response_code" == "$expected_code" ]]; then
              echo "âœ… $description (status: $response_code)"
              return 0
            else
              echo "âŒ $description - expected $expected_code, got $response_code"
              return 1
            fi
          }
          
          # Helper function to test HTTP header
          test_http_header() {
            local url=$1
            local header_name=$2
            local expected_value=$3
            local description=$4
            local extra_args=${5:-}
            
            local header_value
            header_value=$(curl -s -D - -o /dev/null $extra_args "$url" --max-time 10 2>/dev/null | grep -i "^${header_name}:" | cut -d' ' -f2- | tr -d '\r\n' || echo "")
            
            if [[ "$header_value" == *"$expected_value"* ]]; then
              echo "âœ… $description (header $header_name: $header_value)"
              return 0
            else
              echo "âŒ $description - header $header_name expected '$expected_value', got '$header_value'"
              return 1
            fi
          }
          
          echo "=== Test 1: Basic route (port 8080) ==="
          REQUEST_SUCCESS=false
          for i in $(seq 1 $MAX_RETRIES); do
            if test_http "http://${NODE_IP}:${HTTP_PORT}/" "200" "Basic route on port 8080"; then
              REQUEST_SUCCESS=true
              break
            fi
            echo "â³ Retrying in ${RETRY_INTERVAL}s... (attempt $i/$MAX_RETRIES)"
            sleep $RETRY_INTERVAL
          done

          if [[ "$REQUEST_SUCCESS" == "true" ]]; then
            echo "TEST_BASIC_HTTP=âœ… Passed" >> "$GITHUB_ENV"
          else
            echo "âŒ Basic HTTP request failed after $MAX_RETRIES attempts"
            kubectl logs -l app=envoy -n xds-system --tail=50 || true
            exit 1
          fi

          echo ""
          echo "=== Test 2: Complex route (port 8081) ==="
          if test_http "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/" "200" "Complex route on port 8081" && \
             test_http_header "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/" "x-e2e-test" "api-route" "Response header x-e2e-test"; then
            echo "TEST_COMPLEX_HTTP=âœ… Passed" >> "$GITHUB_ENV"
          else
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 3: API route (/api/) ==="
          if test_http "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/api/" "200" "API route (/api/)" && \
             test_http_header "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/api/" "x-e2e-test" "api-route" "API route response header"; then
            echo "TEST_API_ROUTE=âœ… Passed" >> "$GITHUB_ENV"
          else
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 4: Health endpoint ==="
          if test_http "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/health" "200" "Health endpoint (/health)"; then
            echo "TEST_HEALTH=âœ… Passed" >> "$GITHUB_ENV"
          else
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 5: CORS preflight ==="
          CORS_RESPONSE=$(curl -s -D - -o /dev/null -X OPTIONS \
            -H "Origin: http://test.example.com" \
            -H "Access-Control-Request-Method: POST" \
            -H "Access-Control-Request-Headers: X-Custom-Header" \
            "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/api/" --max-time 10 2>/dev/null || echo "")

          if echo "$CORS_RESPONSE" | grep -qi "access-control-allow"; then
            echo "âœ… CORS headers present in preflight response"
            echo "TEST_CORS=âœ… Passed" >> "$GITHUB_ENV"
          else
            echo "âŒ CORS headers not found in preflight response"
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 6: Lua filter response header ==="
          if test_http_header "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/" "x-lua-response" "processed" "Lua filter response header"; then
            echo "TEST_LUA=âœ… Passed" >> "$GITHUB_ENV"
          else
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 7: Redirect path ==="
          REDIRECT_RESPONSE=$(curl -s -D - -o /dev/null "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/old/path" --max-time 10 2>/dev/null || echo "")

          if echo "$REDIRECT_RESPONSE" | grep -q "301\|Location"; then
            echo "âœ… Redirect working (301 response)"
            echo "TEST_REDIRECT=âœ… Passed" >> "$GITHUB_ENV"
          else
            echo "âŒ Redirect path not matched"
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 8: HTTPS route (with self-signed cert) ==="
          HTTPS_CODE=$(curl -s -k -o /dev/null -w "%{http_code}" \
            -H "Host: secure.e2e.local" \
            "https://${NODE_IP}:${HTTPS_PORT}/" --max-time 15 2>/dev/null || echo "000")

          if [[ "$HTTPS_CODE" == "200" ]]; then
            echo "âœ… HTTPS route with TLS responded successfully (status: $HTTPS_CODE)"
            echo "TEST_HTTPS=âœ… Passed" >> "$GITHUB_ENV"
          elif [[ "$HTTPS_CODE" != "000" ]]; then
            echo "âœ… HTTPS/TLS connection established (status: $HTTPS_CODE)"
            echo "TEST_HTTPS=âœ… Passed" >> "$GITHUB_ENV"
          else
            echo "âŒ HTTPS route connection failed"
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 9: TCP proxy (complex - port 9000) ==="
          TCP_COMPLEX_PORT="${{ steps.envoy.outputs.tcp_complex_port }}"
          # TCP proxy forwards to test-backend (HTTP server), so we can test with HTTP request
          TCP_COMPLEX_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "http://${NODE_IP}:${TCP_COMPLEX_PORT}/" --max-time 10 2>/dev/null || echo "000")

          if [[ "$TCP_COMPLEX_CODE" == "200" ]]; then
            echo "âœ… TCP proxy (complex) forwarding works (status: $TCP_COMPLEX_CODE)"
            echo "TEST_TCP_COMPLEX=âœ… Passed" >> "$GITHUB_ENV"
          else
            echo "âŒ TCP proxy (complex) failed (status: $TCP_COMPLEX_CODE)"
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Test 10: TCP proxy (basic - port 9001) ==="
          TCP_BASIC_PORT="${{ steps.envoy.outputs.tcp_basic_port }}"
          TCP_BASIC_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "http://${NODE_IP}:${TCP_BASIC_PORT}/" --max-time 10 2>/dev/null || echo "000")

          if [[ "$TCP_BASIC_CODE" == "200" ]]; then
            echo "âœ… TCP proxy (basic) forwarding works (status: $TCP_BASIC_CODE)"
            echo "TEST_TCP_BASIC=âœ… Passed" >> "$GITHUB_ENV"
          else
            echo "âŒ TCP proxy (basic) failed (status: $TCP_BASIC_CODE)"
            ((TEST_FAILURES++))
          fi

          echo ""
          echo "=== Traffic Test Summary ==="
          if [[ $TEST_FAILURES -eq 0 ]]; then
            echo "âœ… All traffic tests passed!"
          else
            echo "âŒ $TEST_FAILURES traffic test(s) failed"
            echo ""
            echo "=== Debug: Envoy logs ==="
            kubectl logs -l app=envoy -n xds-system --tail=50 || true
            echo ""
            echo "=== Debug: xDS Controller logs ==="
            kubectl logs -l app=xds-controller -n xds-system --tail=50 || true
            exit 1
          fi

      - name: Check Envoy stats and config
        run: |
          NODE_IP="${{ steps.envoy.outputs.node_ip }}"
          ADMIN_PORT="${{ steps.envoy.outputs.admin_port }}"

          echo "=== Envoy Request Stats ==="
          STATS=$(curl -s "http://${NODE_IP}:${ADMIN_PORT}/stats" || echo "")
          echo "$STATS" | grep -E "downstream_rq|upstream_rq" | head -20 || true

          echo ""
          echo "=== Checking complex-cluster stats ==="
          echo "$STATS" | grep -E "cluster\.(complex|simple)-cluster" | head -10 || true

          echo ""
          echo "=== Verifying config structure ==="
          CONFIG_DUMP=$(curl -s "http://${NODE_IP}:${ADMIN_PORT}/config_dump?include_eds" || echo "FAILED")

          if echo "$CONFIG_DUMP" | grep -qi "json_format\|jsonFormat"; then
            echo "âœ… JSON access logging configured"
          else
            echo "âš ï¸ JSON access logging not found"
          fi

          if echo "$CONFIG_DUMP" | grep -qi "retry_policy\|retryPolicy"; then
            echo "âœ… Retry policies configured"
          else
            echo "âš ï¸ Retry policies not found"
          fi

          if echo "$CONFIG_DUMP" | grep -qi "circuit_breakers\|circuitBreakers"; then
            echo "âœ… Circuit breakers configured"
          else
            echo "âš ï¸ Circuit breakers not found"
          fi

          if echo "$CONFIG_DUMP" | grep -qi "health_checks\|healthChecks"; then
            echo "âœ… Health checks configured"
          else
            echo "âš ï¸ Health checks not found"
          fi

          echo ""
          echo "=== Checking TLS secrets (SDS) ==="
          CERTS=$(curl -s "http://${NODE_IP}:${ADMIN_PORT}/certs" || echo "FAILED")
          if echo "$CERTS" | grep -q "e2e-wildcard-cert\|e2e.local"; then
            echo "âœ… TLS secrets found in Envoy config"
          else
            echo "âš ï¸ TLS secrets not found (may not be referenced by active routes)"
          fi

      - name: Test HA scaling (3 replicas)
        run: |
          NODE_IP="${{ steps.envoy.outputs.node_ip }}"
          HTTP_COMPLEX_PORT="${{ steps.envoy.outputs.http_complex_port }}"
          ADMIN_PORT="${{ steps.envoy.outputs.admin_port }}"

          # Initialize results as failed (will be updated on success)
          echo "HA_SCALE_RESULT=âŒ Failed" >> "$GITHUB_ENV"
          echo "HA_CONFIG_RESULT=âŒ Failed" >> "$GITHUB_ENV"
          echo "HA_TRAFFIC_RESULT=âŒ Failed" >> "$GITHUB_ENV"

          echo "=== Testing HA Scaling ==="
          echo "This test verifies xDS controller works correctly with multiple replicas"
          echo ""

          # Step 1: Scale xDS controller to 3 replicas
          echo "Step 1: Scaling xDS controller to 3 replicas..."
          kubectl scale deployment xds-controller -n xds-system --replicas=3
          echo "âœ… Scale command issued"
          echo ""

          # Step 2: Wait for all replicas to be ready
          echo "Step 2: Waiting for all 3 replicas to be ready..."
          kubectl rollout status deployment/xds-controller -n xds-system --timeout=120s
          echo ""

          # Verify pod count
          READY_PODS=$(kubectl get deployment xds-controller -n xds-system -o jsonpath='{.status.readyReplicas}')
          echo "Ready replicas: $READY_PODS"
          if [[ "$READY_PODS" != "3" ]]; then
            echo "âŒ Expected 3 ready replicas, got $READY_PODS"
            kubectl get pods -n xds-system -l app=xds-controller
            exit 1
          fi
          echo "âœ… All 3 replicas are ready"
          echo "HA_SCALE_RESULT=âœ… Passed" >> "$GITHUB_ENV"
          echo ""

          # Step 3: Show pod distribution
          echo "Step 3: Pod distribution..."
          kubectl get pods -n xds-system -l app=xds-controller -o wide
          echo ""

          # Step 4: Verify Envoy still has correct configuration
          echo "Step 4: Verifying Envoy configuration is still correct..."
          CLUSTERS=$(curl -s "http://${NODE_IP}:${ADMIN_PORT}/clusters" || echo "FAILED")

          CLUSTER_CHECK_PASSED=true
          for cluster_name in "complex-cluster" "simple-cluster" "test-backend-cluster"; do
            if echo "$CLUSTERS" | grep -q "$cluster_name"; then
              echo "âœ… Cluster '$cluster_name' still present"
            else
              echo "âŒ Cluster '$cluster_name' missing after scaling"
              CLUSTER_CHECK_PASSED=false
            fi
          done

          if [[ "$CLUSTER_CHECK_PASSED" != "true" ]]; then
            echo "âŒ Cluster configuration lost after scaling"
            exit 1
          fi
          echo "HA_CONFIG_RESULT=âœ… Passed" >> "$GITHUB_ENV"
          echo ""

          # Step 5: Test traffic still works
          echo "Step 5: Testing traffic through Envoy..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/" --max-time 10 || echo "000")

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… HTTP traffic working (status: $HTTP_CODE)"
            echo "HA_TRAFFIC_RESULT=âœ… Passed" >> "$GITHUB_ENV"
          else
            echo "âŒ HTTP traffic failed (status: $HTTP_CODE)"
            exit 1
          fi
          echo ""

          echo "=== HA Scaling Test PASSED ==="
          echo "Successfully verified:"
          echo "  - xDS controller scales to 3 replicas"
          echo "  - Existing Envoy configuration preserved"
          echo "  - Traffic continues to work"

      - name: Test live reconciliation with HA (RDS update)
        run: |
          NODE_IP="${{ steps.envoy.outputs.node_ip }}"
          HTTP_COMPLEX_PORT="${{ steps.envoy.outputs.http_complex_port }}"
          ADMIN_PORT="${{ steps.envoy.outputs.admin_port }}"

          # Initialize results as failed (will be updated on success)
          echo "HA_RDS_RESULT=âŒ Failed" >> "$GITHUB_ENV"
          echo "HA_CDS_RESULT=âŒ Failed" >> "$GITHUB_ENV"

          echo "=== Testing Live Reconciliation with HA Cluster (3 replicas) ==="
          echo "This test verifies that changes to xDS resources are propagated to Envoy"
          echo "when running with multiple controller replicas"
          echo ""

          # Show current controller pods
          echo "Current xDS controller pods:"
          kubectl get pods -n xds-system -l app=xds-controller
          echo ""

          # Step 1: Verify current header value
          echo "Step 1: Checking current x-e2e-test header value..."
          CURRENT_HEADER=$(curl -s -D - -o /dev/null "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/" --max-time 10 2>/dev/null | grep -i "^x-e2e-test:" | cut -d' ' -f2- | tr -d '\r\n' || echo "")
          echo "Current x-e2e-test header: '$CURRENT_HEADER'"

          if [[ "$CURRENT_HEADER" != *"api-route"* ]]; then
            echo "âŒ Expected 'api-route' in header, got '$CURRENT_HEADER'"
            exit 1
          fi
          echo "âœ… Current header value confirmed: api-route"
          echo ""

          # Step 2: Update the RDS resource with a new header value
          echo "Step 2: Updating api-route RDS resource with new header value..."
          kubectl patch route api-route -n xds-system --type='json' -p='[
            {"op": "replace", "path": "/spec/route_config/virtual_hosts/0/response_headers_to_add/0/header/value", "value": "api-route-ha-updated"}
          ]'
          echo "âœ… RDS resource patched"
          echo ""

          # Step 3: Wait for reconciliation
          echo "Step 3: Waiting for xDS controller to reconcile and Envoy to receive update..."
          sleep 10

          # Step 4: Check xDS controller logs for reconciliation (from all pods)
          echo "Step 4: Checking xDS controller logs from all pods..."
          for pod in $(kubectl get pods -n xds-system -l app=xds-controller -o jsonpath='{.items[*].metadata.name}'); do
            echo "--- Logs from $pod ---"
            kubectl logs "$pod" -n xds-system --tail=10 | grep -E "Reconciling|Updated|snapshot" || echo "(no reconcile logs)"
          done
          echo ""

          # Step 5: Verify Envoy received the updated configuration
          echo "Step 5: Verifying Envoy received the updated header value..."
          MAX_RETRIES=6
          RETRY_INTERVAL=5
          UPDATE_VERIFIED=false

          for i in $(seq 1 $MAX_RETRIES); do
            NEW_HEADER=$(curl -s -D - -o /dev/null "http://${NODE_IP}:${HTTP_COMPLEX_PORT}/" --max-time 10 2>/dev/null | grep -i "^x-e2e-test:" | cut -d' ' -f2- | tr -d '\r\n' || echo "")
            echo "Attempt $i: x-e2e-test header = '$NEW_HEADER'"

            if [[ "$NEW_HEADER" == *"api-route-ha-updated"* ]]; then
              echo "âœ… Envoy received updated configuration!"
              UPDATE_VERIFIED=true
              break
            fi

            echo "â³ Update not yet propagated, waiting ${RETRY_INTERVAL}s..."
            sleep $RETRY_INTERVAL
          done

          if [[ "$UPDATE_VERIFIED" != "true" ]]; then
            echo "âŒ Live reconciliation with HA FAILED - Envoy did not receive the updated header"
            echo ""
            echo "=== Debug: xDS Controller logs (all pods) ==="
            for pod in $(kubectl get pods -n xds-system -l app=xds-controller -o jsonpath='{.items[*].metadata.name}'); do
              echo "--- Logs from $pod ---"
              kubectl logs "$pod" -n xds-system --tail=30 || true
            done
            exit 1
          fi
          echo "HA_RDS_RESULT=âœ… Passed" >> "$GITHUB_ENV"

          echo ""
          # Step 6: Create a new CDS resource to test HA reconciliation
          echo "Step 6: Testing CDS reconciliation with HA cluster..."

          cat <<EOF | kubectl apply -f -
          apiVersion: envoyxds.io/v1alpha1
          kind: Cluster
          metadata:
            name: ha-test-cluster
            namespace: xds-system
            annotations:
              clusters: "e2e-test"
              nodes: "e2e-test-node"
          spec:
            name: ha-test-cluster
            connect_timeout: 5s
            type: STRICT_DNS
            lb_policy: ROUND_ROBIN
            load_assignment:
              cluster_name: ha-test-cluster
              endpoints:
                - lb_endpoints:
                    - endpoint:
                        address:
                          socket_address:
                            address: test-backend.xds-system.svc.cluster.local
                            port_value: 80
          EOF
          echo "âœ… New cluster resource created"

          # Wait for reconciliation
          sleep 10

          # Verify the new cluster appears in Envoy
          NEW_CLUSTER_FOUND=false
          for i in $(seq 1 $MAX_RETRIES); do
            CLUSTERS=$(curl -s "http://${NODE_IP}:${ADMIN_PORT}/clusters" || echo "FAILED")
            if echo "$CLUSTERS" | grep -q "ha-test-cluster"; then
              echo "âœ… New cluster 'ha-test-cluster' found in Envoy (attempt $i)"
              NEW_CLUSTER_FOUND=true
              break
            fi
            echo "â³ Cluster not found yet, waiting ${RETRY_INTERVAL}s... (attempt $i/$MAX_RETRIES)"
            sleep $RETRY_INTERVAL
          done

          if [[ "$NEW_CLUSTER_FOUND" != "true" ]]; then
            echo "âŒ HA CDS reconciliation FAILED - new cluster not propagated to Envoy"
            exit 1
          fi
          echo "HA_CDS_RESULT=âœ… Passed" >> "$GITHUB_ENV"

          echo ""
          echo "=== Live Reconciliation with HA Test PASSED ==="
          echo "Successfully verified with 3 controller replicas:"
          echo "  - RDS update -> Controller reconcile -> Envoy config updated"
          echo "  - CDS create -> Controller reconcile -> Envoy cluster added"

      - name: Generate E2E summary
        if: always()
        run: |
          echo "## ðŸš€ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| KIND Cluster | âœ… Created |" >> $GITHUB_STEP_SUMMARY
          echo "| xDS Controller | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Envoy Proxy | âœ… Running |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### xDS Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CDS - All Clusters (6 total) | ${{ env.XDS_CDS_RESULT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LDS - All Listeners (6 total) | ${{ env.XDS_LDS_RESULT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Traffic Tests" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Basic HTTP (port 8080) | ${{ env.TEST_BASIC_HTTP || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Complex HTTP (port 8081) | ${{ env.TEST_COMPLEX_HTTP || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Route (/api/) | ${{ env.TEST_API_ROUTE || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Endpoint | ${{ env.TEST_HEALTH || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CORS Preflight | ${{ env.TEST_CORS || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lua Filter Headers | ${{ env.TEST_LUA || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Redirect Routes | ${{ env.TEST_REDIRECT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HTTPS/TLS (port 8443) | ${{ env.TEST_HTTPS || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TCP Proxy Complex (port 9000) | ${{ env.TEST_TCP_COMPLEX || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TCP Proxy Basic (port 9001) | ${{ env.TEST_TCP_BASIC || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### HA & Live Reconciliation Tests" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Scale to 3 replicas | ${{ env.HA_SCALE_RESULT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Config preserved after scaling | ${{ env.HA_CONFIG_RESULT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Traffic works with 3 replicas | ${{ env.HA_TRAFFIC_RESULT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RDS live update propagated | ${{ env.HA_RDS_RESULT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CDS live create propagated | ${{ env.HA_CDS_RESULT || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Debug on failure
        if: failure()
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n xds-system -o wide
          echo ""
          echo "=== Events ==="
          kubectl get events -n xds-system --sort-by='.lastTimestamp' | tail -30
          echo ""
          echo "=== xDS Resources ==="
          kubectl get listeners,routes,clusters,endpoints,tlssecrets -n xds-system || true
          echo ""
          echo "=== xDS Resources Details ==="
          kubectl describe listeners,routes,clusters -n xds-system | head -100 || true
          echo ""
          echo "=== xDS Controller logs ==="
          kubectl logs -l app=xds-controller -n xds-system --tail=100 || true
          echo ""
          echo "=== Envoy logs ==="
          kubectl logs -l app=envoy -n xds-system --tail=100 || true

      - name: Cleanup
        if: always()
        run: kind delete cluster --name xds-e2e

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for uploading SARIF results
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'table'

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec security scanner
        run: |
          gosec -no-fail -fmt text ./...
          gosec -no-fail -fmt sarif -out results.sarif ./...

      - name: Generate security summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Trivy (Vulnerability Scanner)" >> $GITHUB_STEP_SUMMARY
          echo "Scanned for CRITICAL and HIGH severity vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Gosec (Go Security Checker)" >> $GITHUB_STEP_SUMMARY
          if [ -f results.sarif ]; then
            ISSUES=$(jq '.runs[0].results | length' results.sarif 2>/dev/null || echo "0")
            if [ "$ISSUES" -gt 0 ]; then
              echo "âš ï¸ Found ${ISSUES} potential security issue(s)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No security issues found" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Results uploaded to GitHub Security tab (if enabled)_" >> $GITHUB_STEP_SUMMARY

      # Upload SARIF to GitHub Code Scanning (only works if Code Scanning is enabled)
      # This step will be skipped for forks or if Code Scanning is not available
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        # Only run on push to main or PRs from the same repo (not forks)
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true  # Don't fail the build if Code Scanning is not enabled
        with:
          sarif_file: results.sarif
